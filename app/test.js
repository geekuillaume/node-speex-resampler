"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = require("fs");
// const {promisify} = require('util');
const perf_hooks_1 = require("perf_hooks");
const path_1 = __importDefault(require("path"));
const index_1 = __importStar(require("./index"));
const assert = (condition, message) => {
    if (!condition) {
        throw new Error(message);
    }
};
const audioTests = [
    { inFile: path_1.default.resolve(__dirname, `../resources/24000hz_mono_test.pcm`), inRate: 24000, outRate: 48000, channels: 1, quality: 5 },
    { inFile: path_1.default.resolve(__dirname, `../resources/24000hz_test.pcm`), inRate: 24000, outRate: 24000, channels: 2, quality: 5 },
    { inFile: path_1.default.resolve(__dirname, `../resources/24000hz_test.pcm`), inRate: 24000, outRate: 48000, channels: 2, quality: 10 },
    { inFile: path_1.default.resolve(__dirname, `../resources/44100hz_test.pcm`), inRate: 44100, outRate: 48000, channels: 2 },
    { inFile: path_1.default.resolve(__dirname, `../resources/44100hz_test.pcm`), inRate: 44100, outRate: 48000, channels: 2, quality: 10 },
    { inFile: path_1.default.resolve(__dirname, `../resources/44100hz_test.pcm`), inRate: 44100, outRate: 48000, channels: 2, quality: 1 },
    { inFile: path_1.default.resolve(__dirname, `../resources/44100hz_test.pcm`), inRate: 44100, outRate: 24000, channels: 2, quality: 5 },
];
const promiseBasedTest = async () => {
    await index_1.default.initPromise;
    for (const audioTest of audioTests) {
        console.log(`Resampling file ${audioTest.inFile} with ${audioTest.channels} channel(s) from ${audioTest.inRate}Hz to ${audioTest.outRate}Hz (quality: ${audioTest.quality || 7})`);
        const resampler = new index_1.default(audioTest.channels, audioTest.inRate, audioTest.outRate, audioTest.quality);
        const filename = path_1.default.parse(audioTest.inFile).name;
        const pcmData = fs_1.readFileSync(audioTest.inFile);
        const start = perf_hooks_1.performance.now();
        const res = await resampler.processChunk(pcmData);
        const end = perf_hooks_1.performance.now();
        console.log(`Resampled in ${Math.floor(end - start)}ms`);
        console.log(`Input stream: ${pcmData.length} bytes, ${pcmData.length / audioTest.inRate / 2 / audioTest.channels}s`);
        console.log(`Output stream: ${res.length} bytes, ${res.length / audioTest.outRate / 2 / audioTest.channels}s`);
        const inputDuration = pcmData.length / audioTest.inRate / 2 / audioTest.channels;
        const outputDuration = res.length / audioTest.outRate / 2 / audioTest.channels;
        assert(Math.abs(inputDuration - outputDuration) < 0.01, `Stream duration not matching target, in: ${inputDuration}s != out:${outputDuration}`);
        console.log();
        // writeFileSync(path.resolve(__dirname, `../resources/${filename}_${audioTest.outRate}_${audioTest.quality || 7}_output.pcm`), res);
    }
};
const streamBasedTest = async () => {
    console.log('=================');
    console.log('Tranform Stream Test');
    console.log('=================');
    for (const audioTest of audioTests) {
        console.log(`Resampling file ${audioTest.inFile} with ${audioTest.channels} channel(s) from ${audioTest.inRate}Hz to ${audioTest.outRate}Hz (quality: ${audioTest.quality || 7})`);
        const readFileStream = fs_1.createReadStream(audioTest.inFile);
        const transformStream = new index_1.SpeexResamplerTransform(audioTest.channels, audioTest.inRate, audioTest.outRate, audioTest.quality);
        let pcmData = Buffer.alloc(0);
        readFileStream.on('data', (d) => {
            pcmData = Buffer.concat([pcmData, d]);
        });
        let res = Buffer.alloc(0);
        transformStream.on('data', (d) => {
            res = Buffer.concat([res, d]);
        });
        const start = perf_hooks_1.performance.now();
        readFileStream.pipe(transformStream);
        await new Promise((r) => transformStream.on('end', r));
        const end = perf_hooks_1.performance.now();
        console.log(`Resampled in ${Math.floor(end - start)}ms`);
        console.log(`Input stream: ${pcmData.length} bytes, ${pcmData.length / audioTest.inRate / 2 / audioTest.channels}s`);
        console.log(`Output stream: ${res.length} bytes, ${res.length / audioTest.outRate / 2 / audioTest.channels}s`);
        const inputDuration = pcmData.length / audioTest.inRate / 2 / audioTest.channels;
        const outputDuration = res.length / audioTest.outRate / 2 / audioTest.channels;
        assert(Math.abs(inputDuration - outputDuration) < 0.01, `Stream duration not matching target, in: ${inputDuration}s != out:${outputDuration}`);
        console.log();
    }
};
promiseBasedTest()
    .then(() => streamBasedTest()).catch((e) => {
    console.error(e);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5qcyIsInNvdXJjZVJvb3QiOiIvIiwic291cmNlcyI6WyJ0ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJCQUFnRTtBQUNoRSx1Q0FBdUM7QUFDdkMsMkNBQXdDO0FBQ3hDLGdEQUF3QjtBQUV4QixpREFBZ0U7QUFFaEUsTUFBTSxNQUFNLEdBQUcsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLEVBQUU7SUFDcEMsSUFBSSxDQUFDLFNBQVMsRUFBRTtRQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDMUI7QUFDSCxDQUFDLENBQUE7QUFFRCxNQUFNLFVBQVUsR0FBRztJQUNqQixFQUFDLE1BQU0sRUFBRSxjQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxvQ0FBb0MsQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUM7SUFDL0gsRUFBQyxNQUFNLEVBQUUsY0FBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsK0JBQStCLENBQUMsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFDO0lBQzFILEVBQUMsTUFBTSxFQUFFLGNBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLCtCQUErQixDQUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBQztJQUMzSCxFQUFDLE1BQU0sRUFBRSxjQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSwrQkFBK0IsQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUs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R0FBRyxjQUFjLENBQUMsR0FBRyxJQUFJLEVBQUUsNENBQTRDLGFBQWEsWUFBWSxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQy9JLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztLQUNmO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsZ0JBQWdCLEVBQUU7S0FDakIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7SUFDekMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtyZWFkRmlsZVN5bmMsIHdyaXRlRmlsZVN5bmMsY3JlYXRlUmVhZFN0cmVhbX0gZnJvbSAnZnMnO1xuLy8gY29uc3Qge3Byb21pc2lmeX0gPSByZXF1aXJlKCd1dGlsJyk7XG5pbXBvcnQgeyBwZXJmb3JtYW5jZSB9IGZyb20gJ3BlcmZfaG9va3MnXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IFNwZWV4UmVzYW1wbGVyLCB7U3BlZXhSZXNhbXBsZXJUcmFuc2Zvcm19IGZyb20gJy4vaW5kZXgnO1xuXG5jb25zdCBhc3NlcnQgPSAoY29uZGl0aW9uLCBtZXNzYWdlKSA9PiB7XG4gIGlmICghY29uZGl0aW9uKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UpO1xuICB9XG59XG5cbmNvbnN0IGF1ZGlvVGVzdHMgPSBbXG4gIHtpbkZpbGU6IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIGAuLi9yZXNvdXJjZXMvMjQwMDBoel9tb25vX3Rlc3QucGNtYCksIGluUmF0ZTogMjQwMDAsIG91dFJhdGU6IDQ4MDAwLCBjaGFubmVsczogMSwgcXVhbGl0eTogNX0sXG4gIHtpbkZpbGU6IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIGAuLi9yZXNvdXJjZXMvMjQwMDBoel90ZXN0LnBjbWApLCBpblJhdGU6IDI0MDAwLCBvdXRSYXRlOiAyNDAwMCwgY2hhbm5lbHM6IDIsIHF1YWxpdHk6IDV9LFxuICB7aW5GaWxlOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBgLi4vcmVzb3VyY2VzLzI0MDAwaHpfdGVzdC5wY21gKSwgaW5SYXRlOiAyNDAwMCwgb3V0UmF0ZTogNDgwMDAsIGNoYW5uZWxzOiAyLCBxdWFsaXR5OiAxMH0sXG4gIHtpbkZpbGU6IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIGAuLi9yZXNvdXJjZXMvNDQxMDBoel90ZXN0LnBjbWApLCBpblJhdGU6IDQ0MTAwLCBvdXRSYXRlOiA0ODAwMCwgY2hhbm5lbHM6IDJ9LFxuICB7aW5GaWxlOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBgLi4vcmVzb3VyY2VzLzQ0MTAwaHpfdGVzdC5wY21gKSwgaW5SYXRlOiA0NDEwMCwgb3V0UmF0ZTogNDgwMDAsIGNoYW5uZWxzOiAyLCBxdWFsaXR5OiAxMH0sXG4gIHtpbkZpbGU6IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIGAuLi9yZXNvdXJjZXMvNDQxMDBoel90ZXN0LnBjbWApLCBpblJhdGU6IDQ0MTAwLCBvdXRSYXRlOiA0ODAwMCwgY2hhbm5lbHM6IDIsIHF1YWxpdHk6IDF9LFxuICB7aW5GaWxlOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBgLi4vcmVzb3VyY2VzLzQ0MTAwaHpfdGVzdC5wY21gKSwgaW5SYXRlOiA0NDEwMCwgb3V0UmF0ZTogMjQwMDAsIGNoYW5uZWxzOiAyLCBxdWFsaXR5OiA1fSxcbl07XG5cbmNvbnN0IHByb21pc2VCYXNlZFRlc3QgPSBhc3luYyAoKSA9PiB7XG4gIGF3YWl0IFNwZWV4UmVzYW1wbGVyLmluaXRQcm9taXNlO1xuICBmb3IgKGNvbnN0IGF1ZGlvVGVzdCBvZiBhdWRpb1Rlc3RzKSB7XG4gICAgY29uc29sZS5sb2coYFJlc2FtcGxpbmcgZmlsZSAke2F1ZGlvVGVzdC5pbkZpbGV9IHdpdGggJHthdWRpb1Rlc3QuY2hhbm5lbHN9IGNoYW5uZWwocykgZnJvbSAke2F1ZGlvVGVzdC5pblJhdGV9SHogdG8gJHthdWRpb1Rlc3Qub3V0UmF0ZX1IeiAocXVhbGl0eTogJHthdWRpb1Rlc3QucXVhbGl0eSB8fCA3fSlgKTtcbiAgICBjb25zdCByZXNhbXBsZXIgPSBuZXcgU3BlZXhSZXNhbXBsZXIoYXVkaW9UZXN0LmNoYW5uZWxzLCBhdWRpb1Rlc3QuaW5SYXRlLCBhdWRpb1Rlc3Qub3V0UmF0ZSwgYXVkaW9UZXN0LnF1YWxpdHkpO1xuICAgIGNvbnN0IGZpbGVuYW1lID0gcGF0aC5wYXJzZShhdWRpb1Rlc3QuaW5GaWxlKS5uYW1lO1xuICAgIGNvbnN0IHBjbURhdGEgPSByZWFkRmlsZVN5bmMoYXVkaW9UZXN0LmluRmlsZSk7XG5cbiAgICBjb25zdCBzdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlc2FtcGxlci5wcm9jZXNzQ2h1bmsocGNtRGF0YSk7XG4gICAgY29uc3QgZW5kID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgY29uc29sZS5sb2coYFJlc2FtcGxlZCBpbiAke01hdGguZmxvb3IoZW5kIC0gc3RhcnQpfW1zYCk7XG4gICAgY29uc29sZS5sb2coYElucHV0IHN0cmVhbTogJHtwY21EYXRhLmxlbmd0aH0gYnl0ZXMsICR7cGNtRGF0YS5sZW5ndGggLyBhdWRpb1Rlc3QuaW5SYXRlIC8gMiAvIGF1ZGlvVGVzdC5jaGFubmVsc31zYCk7XG4gICAgY29uc29sZS5sb2coYE91dHB1dCBzdHJlYW06ICR7cmVzLmxlbmd0aH0gYnl0ZXMsICR7cmVzLmxlbmd0aCAvIGF1ZGlvVGVzdC5vdXRSYXRlIC8gMiAvIGF1ZGlvVGVzdC5jaGFubmVsc31zYCk7XG5cbiAgICBjb25zdCBpbnB1dER1cmF0aW9uID0gcGNtRGF0YS5sZW5ndGggLyBhdWRpb1Rlc3QuaW5SYXRlIC8gMiAvIGF1ZGlvVGVzdC5jaGFubmVscztcbiAgICBjb25zdCBvdXRwdXREdXJhdGlvbiA9IHJlcy5sZW5ndGggLyBhdWRpb1Rlc3Qub3V0UmF0ZSAvIDIgLyBhdWRpb1Rlc3QuY2hhbm5lbHM7XG4gICAgYXNzZXJ0KE1hdGguYWJzKGlucHV0RHVyYXRpb24gLSBvdXRwdXREdXJhdGlvbikgPCAwLjAxLCBgU3RyZWFtIGR1cmF0aW9uIG5vdCBtYXRjaGluZyB0YXJnZXQsIGluOiAke2lucHV0RHVyYXRpb259cyAhPSBvdXQ6JHtvdXRwdXREdXJhdGlvbn1gKTtcbiAgICBjb25zb2xlLmxvZygpO1xuICAgIC8vIHdyaXRlRmlsZVN5bmMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgYC4uL3Jlc291cmNlcy8ke2ZpbGVuYW1lfV8ke2F1ZGlvVGVzdC5vdXRSYXRlfV8ke2F1ZGlvVGVzdC5xdWFsaXR5IHx8IDd9X291dHB1dC5wY21gKSwgcmVzKTtcbiAgfVxufVxuXG5jb25zdCBzdHJlYW1CYXNlZFRlc3QgPSBhc3luYyAoKSA9PiB7XG4gIGNvbnNvbGUubG9nKCc9PT09PT09PT09PT09PT09PScpO1xuICBjb25zb2xlLmxvZygnVHJhbmZvcm0gU3RyZWFtIFRlc3QnKTtcbiAgY29uc29sZS5sb2coJz09PT09PT09PT09PT09PT09Jyk7XG5cbiAgZm9yIChjb25zdCBhdWRpb1Rlc3Qgb2YgYXVkaW9UZXN0cykge1xuICAgIGNvbnNvbGUubG9nKGBSZXNhbXBsaW5nIGZpbGUgJHthdWRpb1Rlc3QuaW5GaWxlfSB3aXRoICR7YXVkaW9UZXN0LmNoYW5uZWxzfSBjaGFubmVsKHMpIGZyb20gJHthdWRpb1Rlc3QuaW5SYXRlfUh6IHRvICR7YXVkaW9UZXN0Lm91dFJhdGV9SHogKHF1YWxpdHk6ICR7YXVkaW9UZXN0LnF1YWxpdHkgfHwgN30pYCk7XG4gICAgY29uc3QgcmVhZEZpbGVTdHJlYW0gPSBjcmVhdGVSZWFkU3RyZWFtKGF1ZGlvVGVzdC5pbkZpbGUpO1xuICAgIGNvbnN0IHRyYW5zZm9ybVN0cmVhbSA9IG5ldyBTcGVleFJlc2FtcGxlclRyYW5zZm9ybShhdWRpb1Rlc3QuY2hhbm5lbHMsIGF1ZGlvVGVzdC5pblJhdGUsIGF1ZGlvVGVzdC5vdXRSYXRlLCBhdWRpb1Rlc3QucXVhbGl0eSk7XG4gICAgbGV0IHBjbURhdGEgPSBCdWZmZXIuYWxsb2MoMCk7XG4gICAgcmVhZEZpbGVTdHJlYW0ub24oJ2RhdGEnLCAoZCkgPT4ge1xuICAgICAgcGNtRGF0YSA9IEJ1ZmZlci5jb25jYXQoWyBwY21EYXRhLCBkIGFzIEJ1ZmZlciBdKTtcbiAgICB9KTtcbiAgICBsZXQgcmVzID0gQnVmZmVyLmFsbG9jKDApO1xuICAgIHRyYW5zZm9ybVN0cmVhbS5vbignZGF0YScsIChkKSA9PiB7XG4gICAgICByZXMgPSBCdWZmZXIuY29uY2F0KFsgcmVzLCBkIGFzIEJ1ZmZlciBdKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHN0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgcmVhZEZpbGVTdHJlYW0ucGlwZSh0cmFuc2Zvcm1TdHJlYW0pO1xuICAgIGF3YWl0IG5ldyBQcm9taXNlKChyKSA9PiB0cmFuc2Zvcm1TdHJlYW0ub24oJ2VuZCcsIHIpKTtcbiAgICBjb25zdCBlbmQgPSBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICBjb25zb2xlLmxvZyhgUmVzYW1wbGVkIGluICR7TWF0aC5mbG9vcihlbmQgLSBzdGFydCl9bXNgKTtcbiAgICBjb25zb2xlLmxvZyhgSW5wdXQgc3RyZWFtOiAke3BjbURhdGEubGVuZ3RofSBieXRlcywgJHtwY21EYXRhLmxlbmd0aCAvIGF1ZGlvVGVzdC5pblJhdGUgLyAyIC8gYXVkaW9UZXN0LmNoYW5uZWxzfXNgKTtcbiAgICBjb25zb2xlLmxvZyhgT3V0cHV0IHN0cmVhbTogJHtyZXMubGVuZ3RofSBieXRlcywgJHtyZXMubGVuZ3RoIC8gYXVkaW9UZXN0Lm91dFJhdGUgLyAyIC8gYXVkaW9UZXN0LmNoYW5uZWxzfXNgKTtcblxuICAgIGNvbnN0IGlucHV0RHVyYXRpb24gPSBwY21EYXRhLmxlbmd0aCAvIGF1ZGlvVGVzdC5pblJhdGUgLyAyIC8gYXVkaW9UZXN0LmNoYW5uZWxzO1xuICAgIGNvbnN0IG91dHB1dER1cmF0aW9uID0gcmVzLmxlbmd0aCAvIGF1ZGlvVGVzdC5vdXRSYXRlIC8gMiAvIGF1ZGlvVGVzdC5jaGFubmVscztcbiAgICBhc3NlcnQoTWF0aC5hYnMoaW5wdXREdXJhdGlvbiAtIG91dHB1dER1cmF0aW9uKSA8IDAuMDEsIGBTdHJlYW0gZHVyYXRpb24gbm90IG1hdGNoaW5nIHRhcmdldCwgaW46ICR7aW5wdXREdXJhdGlvbn1zICE9IG91dDoke291dHB1dER1cmF0aW9ufWApO1xuICAgIGNvbnNvbGUubG9nKCk7XG4gIH1cbn1cblxucHJvbWlzZUJhc2VkVGVzdCgpXG4udGhlbigoKSA9PiBzdHJlYW1CYXNlZFRlc3QoKSkuY2F0Y2goKGUpID0+IHtcbiAgY29uc29sZS5lcnJvcihlKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufSlcbiJdfQ==